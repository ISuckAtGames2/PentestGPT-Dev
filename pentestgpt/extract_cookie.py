import platform
from pycookiecheat import chrome_cookies
import requests
import pprint
import os
from pathlib import Path

def main():
    url = "https://chat.openai.com/public-api/conversation_limit"

    # Determine the operating system
    os_name = platform.system()
    cookie_file = os.getenv("BROWSER_COOKIE_DB")

    if not cookie_file:
        home = str(Path.home())
        base_dirs = []
        profile_dirs = ["Default"] + [f"Profile {i}" for i in range(1, 21)]

        if os_name == "Darwin":  # macOS
            base_dirs.append(Path(home, "Library/Application Support/Google/Chrome"))
            base_dirs.append(Path(home, "Library/Application Support/Chromium"))
        elif os_name == "Linux":
            base_dirs.append(Path(home, ".config/google-chrome"))
            base_dirs.append(Path(home, ".config/chromium"))
        elif os_name == "Windows":
            base_dirs.append(Path(home, "AppData/Local/Google/Chrome/User Data"))
            base_dirs.append(Path(home, "AppData/Local/chromium/User Data"))
        else:
            raise Exception("Unsupported operating system: " + os_name)

        for base_dir in base_dirs:
            if not base_dir.is_dir():
                print(f"Base directory does not exist: {base_dir}")
                continue

            for profile_dir in profile_dirs:
                path = base_dir / profile_dir
                cookies_file = path / ("Network" if os_name == "Windows" else "Cookies")

                if cookies_file.is_file():
                    try:
                        cookies = chrome_cookies(url, cookie_file=str(cookies_file))
                        cookies_string = "; ".join(f"{k}={v}" for k, v in cookies.items())
                        print(f"For profile {profile_dir} in {base_dir}, the cookies are:\n")
                        print("export CHATGPT_COOKIE='" + cookies_string + "'")
                    except Exception as e:
                        print(f"Failed to extract cookies from {cookies_file}: {str(e)}")
                else:
                    print(f"Cookies file does not exist for profile {profile_dir} in {base_dir}: {cookies_file}")

    elif os.path.isfile(cookie_file):
        try:
            cookies = chrome_cookies(url, cookie_file=cookie_file)
            cookies_string = "; ".join(f"{k}={v}" for k, v in cookies.items())
            print("Run the following command to set the cookie:\n")
            print("export CHATGPT_COOKIE='" + cookies_string + "'")
        except Exception as e:
            print(f"Failed to extract cookies from {cookie_file}: {str(e)}")
    else:
        print(
            "Please set BROWSER_COOKIE_DB to point to a valid cookies db "
            "(e.g. 'export BROWSER_COOKIE_DB=~/.config/google-chrome/Profile 1/Cookies')."
        )

if __name__ == "__main__":
    main()
