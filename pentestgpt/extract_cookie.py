import platform
from pycookiecheat import chrome_cookies
from rich.console import Console
import pprint
import os
from pathlib import Path

def main():
    console = Console()
    url = "https://chat.openai.com/public-api/conversation_limit"

    # Determine the operating system
    os_name = platform.system()
    cookie_file = os.getenv("BROWSER_COOKIE_DB")

    if not cookie_file:
        home = str(Path.home())

        base_dirs = []
        if os_name == "Darwin":  # macOS
            base_dirs.append(Path(home, "Library/Application Support/Google/Chrome"))
            base_dirs.append(Path(home, "Library/Application Support/Chromium"))
        elif os_name == "Linux":
            base_dirs.append(Path(home, ".config/google-chrome"))
            base_dirs.append(Path(home, ".config/chromium"))
        elif os_name == "Windows":
            base_dirs.append(Path(home, "AppData/Local/Google/Chrome/User Data"))
            base_dirs.append(Path(home, "AppData/Local/chromium/User Data"))
        else:
            raise Exception("Unsupported operating system: " + os_name)

        # Iterate over the base directories (Chrome and Chromium)
        for base_dir in base_dirs:
            if not base_dir.is_dir():
                console.print(f"Base directory does not exist: {base_dir}", style="bold yellow")
                continue

            # Iterate over the profiles in the base directory
            for profile_dir in base_dir.iterdir():
                # Ignore any files, we're only interested in directories
                if not profile_dir.is_dir():
                    continue
                # The 'Cookies' file is in the root of the profile directory on macOS and Linux,
                # and in the 'Network' subdirectory on Windows
                cookies_file = profile_dir / ("Network" if os_name == "Windows" else "Cookies")
                # If the 'Cookies' file exists, then we've found a valid profile
                if cookies_file.is_file():
                    cookies = chrome_cookies(url, cookie_file=str(cookies_file))
                    cookies_string = "; ".join(f"{k}={v}" for k, v in cookies.items())
                    console.print(f"For profile {profile_dir.name}, the cookies are:\n")
                    console.print("export CHATGPT_COOKIE='" + cookies_string + "'")
                else:
                    console.print(
                        f"Cookies file does not exist for profile {profile_dir.name}: {cookies_file}",
                        style="bold yellow",
                    )
    else:
        if os.path.isfile(cookie_file):
            cookies = chrome_cookies(url, cookie_file=cookie_file)
            cookies_string = "; ".join(f"{k}={v}" for k, v in cookies.items())
            console.print("Run the following command to set the cookie:\n")
            console.print("export CHATGPT_COOKIE='" + cookies_string + "'")
        else:
            console.print(
                "Please set BROWSER_COOKIE_DB to point to a valid cookies db "
                "(e.g. 'export BROWSER_COOKIE_DB=~/.config/google-chrome/Profile 1/Cookies').",
                style="bold yellow",
            )


if __name__ == "__main__":
    main()
